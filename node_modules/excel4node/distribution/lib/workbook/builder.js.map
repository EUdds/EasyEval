{"version":3,"sources":["../../../source/lib/workbook/builder.js"],"names":["xmlbuilder","require","JSZip","fs","CTColor","utils","addRootContentTypesXML","promiseObj","Promise","resolve","reject","xml","create","att","contentTypesAdded","extensionsAdded","wb","sheets","forEach","s","i","drawingCollection","length","drawings","d","indexOf","extension","typeRef","contentType","ele","push","sheetId","xmlString","doc","end","xmlOutVars","xlsx","file","addRootRelsXML","folder","addWorkBookXML","booksViewEle","workbookViewEle","opts","workbookView","viewOpts","activeTab","autoFilterDateGrouping","boolToInt","firstSheet","minimized","showHorizontalScroll","showSheetTabs","showVerticalScroll","tabRatio","visibility","windowWidth","windowHeight","xWindow","yWindow","sheetsEle","name","definedNameCollection","isEmpty","addToXMLele","addWorkBookRelsXML","addWorkSheetsXML","curSheet","processNextSheet","thisSheet","generateXML","then","generateRelsXML","catch","e","logger","error","stack","addSharedStringsXML","sharedStrings","txt","Array","thisSI","theseRuns","currProps","curRun","undefined","props","text","Object","keys","k","value","run","thisRun","thisRunProps","bold","italics","strike","outline","shadow","condense","extend","color","thisColor","size","underline","vertAlign","addStylesXML","styleData","numFmts","nfXML","nf","fontXML","fonts","f","fillXML","fills","fXML","borderXML","borders","b","cellXfsXML","styles","addXFtoXMLele","dxfCollection","addDrawingsXML","mediaCollection","ws","drawingRelXML","drawingsXML","kind","target","id","image","imagePath","readFileSync","rId","type","drawingsXMLStr","drawingRelXMLStr","writeToBuffer","WorkSheet","jszip","generateAsync","buf","module","exports"],"mappings":"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","file":"builder.js","sourcesContent":["const xmlbuilder = require('xmlbuilder');\nconst JSZip = require('jszip');\nconst fs = require('fs');\nconst CTColor = require('../style/classes/ctColor.js');\nconst utils = require('../utils');\n\nlet addRootContentTypesXML = (promiseObj) => {\n    // Required as stated in §12.2\n    return new Promise ((resolve, reject) => {\n        let xml = xmlbuilder.create(\n            'Types',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true,\n                'allowSurrogateChars': true\n            }\n        )\n        .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/content-types');\n\n        let contentTypesAdded = [];\n        let extensionsAdded = [];\n        promiseObj.wb.sheets.forEach((s, i) => {\n            if (s.drawingCollection.length > 0) { \n                s.drawingCollection.drawings.forEach((d) => {\n                    if (extensionsAdded.indexOf(d.extension) < 0) {\n                        let typeRef = d.contentType + '.' + d.extension;\n                        if (contentTypesAdded.indexOf(typeRef) < 0) {\n                            xml.ele('Default').att('ContentType', d.contentType).att('Extension', d.extension);\n                        }\n                        extensionsAdded.push(d.extension);\n                    }\n                });\n            }\n        });\n        xml.ele('Default').att('ContentType', 'application/xml').att('Extension', 'xml');\n        xml.ele('Default').att('ContentType', 'application/vnd.openxmlformats-package.relationships+xml').att('Extension', 'rels');\n        xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml').att('PartName', '/xl/workbook.xml');\n        promiseObj.wb.sheets.forEach((s, i) => {\n            xml.ele('Override')\n            .att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml')\n            .att('PartName', `/xl/worksheets/sheet${i + 1}.xml`);\n\n            if (s.drawingCollection.length > 0) {              \n                xml.ele('Override')\n                .att('ContentType', 'application/vnd.openxmlformats-officedocument.drawing+xml')\n                .att('PartName', '/xl/drawings/drawing' + s.sheetId + '.xml');  \n            }\n        });\n        xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml').att('PartName', '/xl/styles.xml');\n        xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml').att('PartName', '/xl/sharedStrings.xml');\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.file('[Content_Types].xml', xmlString);\n        resolve(promiseObj);\n    });\n};\n\nlet addRootRelsXML = (promiseObj) => {\n    // Required as stated in §12.2\n    return new Promise ((resolve, reject) => {\n        let xml = xmlbuilder.create(\n            'Relationships',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true\n            }\n        )\n        .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n        xml\n        .ele('Relationship')\n        .att('Id', 'rId1')\n        .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument')\n        .att('Target', 'xl/workbook.xml');\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.folder('_rels').file('.rels', xmlString);\n        resolve(promiseObj);\n\n    });\n};\n\nlet addWorkBookXML = (promiseObj) => {\n    // Required as stated in §12.2\n    return new Promise((resolve, reject) => {\n\n        let xml = xmlbuilder.create(\n            'workbook',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true\n            }\n        );\n        xml.att('mc:Ignorable', 'x15');\n        xml.att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\n        xml.att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006');\n        xml.att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships');\n        xml.att('xmlns:x15', 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main');\n\n        let booksViewEle = xml.ele('bookViews');\n        let workbookViewEle = booksViewEle.ele('workbookView');\n        // bookViews (§18.2.1)\n        if (promiseObj.wb.opts.workbookView) {\n            const viewOpts = promiseObj.wb.opts.workbookView;\n            if (viewOpts.activeTab) {\n                workbookViewEle.att('activeTab', viewOpts.activeTab);\n            }\n            if (viewOpts.autoFilterDateGrouping ) {\n                workbookViewEle.att('autoFilterDateGrouping', utils.boolToInt(viewOpts.autoFilterDateGrouping));\n            }\n            if (viewOpts.firstSheet ) {\n                workbookViewEle.att('firstSheet', viewOpts.firstSheet);\n            }\n            if (viewOpts.minimized ) {\n                workbookViewEle.att('minimized', utils.boolToInt(viewOpts.minimized));\n            }\n            if (viewOpts.showHorizontalScroll ) {\n                workbookViewEle.att('showHorizontalScroll', utils.boolToInt(viewOpts.showHorizontalScroll));\n            }\n            if (viewOpts.showSheetTabs ) {\n                workbookViewEle.att('showSheetTabs', utils.boolToInt(viewOpts.showSheetTabs));\n            }\n            if (viewOpts.showVerticalScroll ) {\n                workbookViewEle.att('showVerticalScroll', utils.boolToInt(viewOpts.showVerticalScroll));\n            }\n            if (viewOpts.tabRatio) {\n                workbookViewEle.att('tabRatio', viewOpts.tabRatio);\n            }\n            if (viewOpts.visibility) {\n                workbookViewEle.att('visibility', viewOpts.visibility);\n            }\n            if (viewOpts.windowWidth) {\n                workbookViewEle.att('windowWidth', viewOpts.windowWidth);\n            }\n            if (viewOpts.windowHeight) {\n                workbookViewEle.att('windowHeight', viewOpts.windowHeight);\n            }\n            if (viewOpts.xWindow) {\n                workbookViewEle.att('xWindow', viewOpts.xWindow);\n            }\n            if (viewOpts.yWindow) {\n                workbookViewEle.att('yWindow', viewOpts.yWindow);\n            }\n        }\n\n        let sheetsEle = xml.ele('sheets');\n        promiseObj.wb.sheets.forEach((s, i) => {\n            sheetsEle.ele('sheet')\n            .att('name', s.name)\n            .att('sheetId', i + 1)\n            .att('r:id', `rId${i + 1}`);\n        });\n\n        if (!promiseObj.wb.definedNameCollection.isEmpty) {\n            promiseObj.wb.definedNameCollection.addToXMLele(xml);\n        }\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.folder('xl').file('workbook.xml', xmlString);\n        resolve(promiseObj);\n\n    });\n};\n\nlet addWorkBookRelsXML = (promiseObj) => {\n    // Required as stated in §12.2\n    return new Promise((resolve, reject) => {\n\n        let xml = xmlbuilder.create(\n            'Relationships',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true\n            }\n        )\n        .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n        xml\n        .ele('Relationship')\n        .att('Id', `rId${promiseObj.wb.sheets.length + 1}`)\n        .att('Target', 'sharedStrings.xml')\n        .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings');\n\n        xml\n        .ele('Relationship')\n        .att('Id', `rId${promiseObj.wb.sheets.length + 2}`)\n        .att('Target', 'styles.xml')\n        .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles');\n\n        promiseObj.wb.sheets.forEach((s, i) => {\n            xml\n            .ele('Relationship')\n            .att('Id', `rId${i + 1}`)\n            .att('Target', `worksheets/sheet${i + 1}.xml`)\n            .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet');\n        });\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.folder('xl').folder('_rels').file('workbook.xml.rels', xmlString);\n        resolve(promiseObj);\n\n    });\n};\n\nlet addWorkSheetsXML = (promiseObj) => {\n    // Required as stated in §12.2\n    return new Promise ((resolve, reject) => {\n\n        let curSheet = 0;\n        \n        let processNextSheet = () => {\n            let thisSheet = promiseObj.wb.sheets[curSheet];\n            if (thisSheet) {\n                curSheet++;\n                thisSheet.generateXML()\n                .then((xml) => {\n                    return new Promise((resolve) =>{\n                        // Add worksheet to zip\n                        promiseObj.xlsx.folder('xl').folder('worksheets').file(`sheet${curSheet}.xml`, xml); \n                        \n                        resolve();\n                    });\n                })\n                .then(() => {\n                    return thisSheet.generateRelsXML();\n                })\n                .then((xml) => {\n                    return new Promise((resolve) => {\n                        if (xml) {\n                            promiseObj.xlsx.folder('xl').folder('worksheets').folder('_rels').file(`sheet${curSheet}.xml.rels`, xml);\n                        }\n                        resolve();\n                    });\n                })\n                .then(processNextSheet)\n                .catch((e) => {\n                    promiseObj.wb.logger.error(e.stack);\n                });\n            } else {\n                resolve(promiseObj);\n            }\n        };\n        processNextSheet();\n\n    });\n};\n\n/**\n * Generate XML for SharedStrings.xml file and add it to zip file. Called from _writeToBuffer()\n * @private\n * @memberof WorkBook\n * @param {Object} promiseObj object containing jszip instance, workbook intance and xmlvars\n * @return {Promise} Resolves with promiseObj\n */\nlet addSharedStringsXML = (promiseObj) => {\n    // §12.3.15 Shared String Table Part\n    return new Promise ((resolve, reject) => {\n\n        let xml = xmlbuilder.create(\n            'sst',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true,\n                'allowSurrogateChars': true\n            }\n        )\n        .att('count', promiseObj.wb.sharedStrings.length)\n        .att('uniqueCount', promiseObj.wb.sharedStrings.length)\n        .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\n\n        promiseObj.wb.sharedStrings.forEach((s) => {\n            if (typeof s === 'string') {\n                xml.ele('si').ele('t').txt(s);\n            } else if (s instanceof Array) {\n\n                let thisSI = xml.ele('si');\n                let theseRuns = []; // §18.4.4 r (Rich Text Run)\n                let currProps = {};\n                let curRun;\n                let i = 0;\n                while (i < s.length) {\n                    if (typeof s[i] === 'string') {\n                        if (curRun === undefined) {\n                            theseRuns.push({\n                                props: {},\n                                text: ''\n                            });\n                            curRun = theseRuns[theseRuns.length - 1];\n                        } \n                        curRun.text = curRun.text + s[i];\n                    } else if (typeof s[i] === 'object') {\n                        theseRuns.push({\n                            props: {},\n                            text: ''\n                        });\n                        curRun = theseRuns[theseRuns.length - 1];\n                        Object.keys(s[i]).forEach((k) => {\n                            currProps[k] = s[i][k];\n                        });\n                        Object.keys(currProps).forEach((k) => {\n                            curRun.props[k] = currProps[k];\n                        });\n                        if (s[i].value !== undefined) {\n                            curRun.text = s[i].value;\n                        }\n                    }\n                    i++;\n                }\n\n                theseRuns.forEach((run) => {\n                    if (Object.keys(run).length < 1) {\n                        thisSI.ele('t', run.text).att('xml:space', 'preserve');\n                    } else {\n                        let thisRun = thisSI.ele('r');\n                        let thisRunProps = thisRun.ele('rPr');\n                        typeof run.props.name === 'string' ? thisRunProps.ele('rFont').att('val', run.props.name) : null;\n                        run.props.bold === true ? thisRunProps.ele('b') : null;\n                        run.props.italics === true ? thisRunProps.ele('i') : null;\n                        run.props.strike === true ? thisRunProps.ele('strike') : null;\n                        run.props.outline === true ? thisRunProps.ele('outline') : null;\n                        run.props.shadow === true ? thisRunProps.ele('shadow') : null;\n                        run.props.condense === true ? thisRunProps.ele('condense') : null;\n                        run.props.extend === true ? thisRunProps.ele('extend') : null;\n                        if (typeof run.props.color === 'string') {\n                            let thisColor = new CTColor(run.props.color);\n                            thisColor.addToXMLele(thisRunProps);\n                        }\n                        typeof run.props.size === 'number' ? thisRunProps.ele('sz').att('val', run.props.size) : null;\n                        run.props.underline === true ? thisRunProps.ele('u') : null;\n                        typeof run.props.vertAlign === 'string' ? thisRunProps.ele('vertAlign').att('val', run.props.vertAlign) : null;\n                        thisRun.ele('t', run.text).att('xml:space', 'preserve');\n                    }\n                });\n\n            }\n        });\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.folder('xl').file('sharedStrings.xml', xmlString);\n\n        resolve(promiseObj);\n\n    });\n};\n\nlet addStylesXML = (promiseObj) => {\n    // §12.3.20 Styles Part\n    return new Promise ((resolve, reject) => {\n\n        let xml = xmlbuilder.create(\n            'styleSheet',\n            {\n                'version': '1.0', \n                'encoding': 'UTF-8', \n                'standalone': true,\n                'allowSurrogateChars': true\n            }\n        )\n        .att('mc:Ignorable', 'x14ac')\n        .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main')\n        .att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006')\n        .att('xmlns:x14ac', 'http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac');\n\n        if (promiseObj.wb.styleData.numFmts.length > 0) {\n            let nfXML = xml\n            .ele('numFmts')\n            .att('count', promiseObj.wb.styleData.numFmts.length);\n            promiseObj.wb.styleData.numFmts.forEach((nf) => {\n                nf.addToXMLele(nfXML);\n            });\n        }\n\n        let fontXML = xml\n        .ele('fonts')\n        .att('count', promiseObj.wb.styleData.fonts.length);\n        promiseObj.wb.styleData.fonts.forEach((f) => {\n            f.addToXMLele(fontXML);\n        });\n\n        let fillXML = xml \n        .ele('fills')\n        .att('count', promiseObj.wb.styleData.fills.length);\n        promiseObj.wb.styleData.fills.forEach((f) => {\n            let fXML = fillXML.ele('fill');\n            f.addToXMLele(fXML);\n        });\n\n        let borderXML = xml \n        .ele('borders')\n        .att('count', promiseObj.wb.styleData.borders.length);\n        promiseObj.wb.styleData.borders.forEach((b) => {\n            b.addToXMLele(borderXML);\n        });\n\n\n        let cellXfsXML = xml \n        .ele('cellXfs')\n        .att('count', promiseObj.wb.styles.length);\n        promiseObj.wb.styles.forEach((s) => {\n            s.addXFtoXMLele(cellXfsXML);\n        });\n\n        if (promiseObj.wb.dxfCollection.length > 0) {\n            promiseObj.wb.dxfCollection.addToXMLele(xml);\n        }\n\n        let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n        promiseObj.xlsx.folder('xl').file('styles.xml', xmlString);\n\n        resolve(promiseObj);\n    });\n};\n\nlet addDrawingsXML = (promiseObj) => {\n    return new Promise((resolve) => {\n        if (!promiseObj.wb.mediaCollection.isEmpty) {\n\n            promiseObj.wb.sheets.forEach((ws) => {\n                if (!ws.drawingCollection.isEmpty) {\n\n                    let drawingRelXML = xmlbuilder.create('Relationships', \n                        {\n                            'version': '1.0', \n                            'encoding': 'UTF-8', \n                            'standalone': true\n                        }\n                    )\n                    .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n                    let drawingsXML = xmlbuilder.create(\n                        'xdr:wsDr',\n                        {\n                            'version': '1.0', \n                            'encoding': 'UTF-8', \n                            'standalone': true\n                        }\n                    );\n                    drawingsXML\n                    .att('xmlns:a', 'http://schemas.openxmlformats.org/drawingml/2006/main')\n                    .att('xmlns:xdr', 'http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing');\n\n                    ws.drawingCollection.drawings.forEach((d) => {\n\n                        if (d.kind === 'image') {\n                            let target = 'image' + d.id + '.' + d.extension;\n\n                            let image = d.imagePath ? fs.readFileSync(d.imagePath) : d.image;\n                            promiseObj.xlsx.folder('xl').folder('media').file(target, image);\n\n                            drawingRelXML.ele('Relationship')\n                            .att('Id', d.rId)\n                            .att('Target', '../media/' + target)\n                            .att('Type', d.type);\n\n                        }\n\n\n\n                        d.addToXMLele(drawingsXML);\n                        \n                    });\n\n                    let drawingsXMLStr = drawingsXML.doc().end(promiseObj.xmlOutVars);\n                    let drawingRelXMLStr = drawingRelXML.doc().end(promiseObj.xmlOutVars);\n                    promiseObj.xlsx.folder('xl').folder('drawings').file('drawing' + ws.sheetId + '.xml', drawingsXMLStr);\n                    promiseObj.xlsx.folder('xl').folder('drawings').folder('_rels').file('drawing' + ws.sheetId + '.xml.rels', drawingRelXMLStr);\n                }\n            });\n\n        }\n        resolve(promiseObj);\n    });\n};\n\n/**\n * Use JSZip to generate file to a node buffer\n * @private\n * @memberof WorkBook\n * @param {WorkBook} wb WorkBook instance\n * @return {Promise} resolves with Buffer \n */\nlet writeToBuffer = (wb) => {\n    return new Promise ((resolve, reject) => {\n        let promiseObj = {\n            wb: wb, \n            xlsx: new JSZip(),\n            xmlOutVars: {}\n        };\n\n        if (promiseObj.wb.sheets.length === 0) {\n            promiseObj.wb.WorkSheet();\n        }\n\n        addRootContentTypesXML(promiseObj)\n        .then(addWorkSheetsXML)\n        .then(addRootRelsXML)\n        .then(addWorkBookXML)\n        .then(addWorkBookRelsXML)\n        .then(addSharedStringsXML)\n        .then(addStylesXML)\n        .then(addDrawingsXML)\n        .then(() => {\n            wb.opts.jszip.type = 'nodebuffer';\n            promiseObj.xlsx.generateAsync(wb.opts.jszip)\n            .then((buf) => {\n                resolve(buf);\n            })\n            .catch((e) => {\n                reject(e);\n            });\n        })\n        .catch((e) => {\n            reject(e);\n        });\n\n    });\n};\n\nmodule.exports = { writeToBuffer };"]}